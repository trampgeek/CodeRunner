{"version":3,"file":"ui_ace.min.js","sources":["../src/ui_ace.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to interface to the Ace editor, which is used both in\n * the author editing page and by the student question submission page.\n * The class defined in this module is a plugin for the InterfaceWrapper class\n * declared in userinterfacewrapper.js. See that file for an explanation of\n * the interface to this module.\n *\n * A special case behaviour of the AceWrapper is that it needs to know\n * the Programming language that is being edited. This MUST be provided in\n * the constructor params parameter (an associative array) as a string\n * with key 'lang'.\n *\n * @module qtype_coderunner/ui_ace\n * @copyright  Richard Lobb, 2015, 2017, The University of Canterbury\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// Thanks to Ulrich Dangel for the initial implementation of Ace within\n// CodeRunner.\n\n// WARNING: The ace editor must have already been loaded before this\n// module is used, as it assumes window.ace exists.\n\ndefine(['jquery'], function($) {\n    /**\n     * Constructor for the Ace interface object.\n     * @param {string} textareaId The ID of the HTML textarea element to be wrapped.\n     * @param {int} w The width in pixels of the textarea.\n     * @param {int} h The height in pixels of the textarea.\n     * @param {object} params The UI parameter object.\n     */\n    function AceWrapper(textareaId, w, h, params) {\n        const ACE_DARK_THEME = 'ace/theme/tomorrow_night';\n        const ACE_LIGHT_THEME = 'ace/theme/textmate';\n\n        var textarea = $(document.getElementById(textareaId)),\n            wrapper = $(document.getElementById(textareaId + '_wrapper')),\n            focused = textarea[0] === document.activeElement,\n            lang = params.lang,\n            session,\n            t = this;  // For embedded callbacks.\n\n        try {\n            window.ace.require(\"ace/ext/language_tools\");\n            this.modelist = window.ace.require('ace/ext/modelist');\n\n            this.textarea = textarea;\n            this.enabled = false;\n            this.contents_changed = false;\n            this.capturingTab = false;\n            this.clickInProgress = false;\n\n            this.editNode = $(\"<div></div>\"); // Ace editor manages this\n            this.editNode.css({\n                resize: 'none',\n                height: h,\n                width: \"100%\"\n            });\n\n            this.editor = window.ace.edit(this.editNode.get(0));\n            if (textarea.prop('readonly')) {\n                this.editor.setReadOnly(true);\n            }\n\n            this.editor.setOptions({\n                enableBasicAutocompletion: true,\n                newLineMode: \"unix\",\n            });\n            this.editor.$blockScrolling = Infinity;\n\n            session = this.editor.getSession();\n            session.setValue(this.textarea.val());\n\n            this.fixSlowLoad();\n\n            // Set theme if available (not currently enabled).\n            if (params.theme) {\n                this.editor.setTheme(\"ace/theme/\" + params.theme);\n            }\n\n            // Set theme to dark if user-prefers-color-scheme is dark,\n            // else use the uiParams theme if provided else use light.\n            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {\n                this.editor.setTheme(ACE_DARK_THEME);\n            } else if (params.theme) {\n                this.editor.setTheme(\"ace/theme/\" + params.theme);\n            } else {\n                this.editor.setTheme(ACE_LIGHT_THEME);\n            }\n\n            this.setLanguage(lang);\n\n            this.setEventHandlers(textarea);\n            this.captureTab();\n\n            // Try to tell Moodle about parts of the editor with z-index.\n            // It is hard to be sure if this is complete. ACE adds all its CSS using JavaScript.\n            // Here, we just deal with things that are known to cause a problem.\n            // Can't do these operations until editor has rendered. So ...\n            this.editor.renderer.on('afterRender', function() {\n                var gutter =  wrapper.find('.ace_gutter');\n                if (gutter.hasClass('moodle-has-zindex')) {\n                    return;  // So we only do what follows once.\n                }\n                gutter.addClass('moodle-has-zindex');\n\n                if (focused) {\n                    t.editor.focus();\n                    t.editor.navigateFileEnd();\n                }\n                t.aceLabel = wrapper.find('.answerprompt');\n                t.aceLabel.attr('for', 'ace_' + textareaId);\n\n                t.aceTextarea = wrapper.find('.ace_text-input');\n                t.aceTextarea.attr('id', 'ace_' + textareaId);\n            });\n\n            this.fail = false;\n        }\n        catch(err) {\n            // Something ugly happened. Probably ace editor hasn't been loaded\n            this.fail = true;\n        }\n    }\n\n\n    AceWrapper.prototype.failed = function() {\n        return this.fail;\n    };\n\n    AceWrapper.prototype.failMessage = function() {\n        return 'ace_ui_notready';\n    };\n\n\n    // Sync to TextArea\n    AceWrapper.prototype.sync = function() {\n        // Nothing to do ... always sync'd\n    };\n\n    AceWrapper.prototype.syncIntervalSecs = function() {\n        return 0;\n    };\n\n    AceWrapper.prototype.setLanguage = function(language) {\n        var session = this.editor.getSession(),\n            mode = this.findMode(language);\n        if (mode) {\n            session.setMode(mode.mode);\n        }\n    };\n\n    AceWrapper.prototype.getElement = function() {\n        return this.editNode;\n    };\n\n    AceWrapper.prototype.captureTab = function () {\n        this.capturingTab = true;\n        this.editor.commands.bindKeys({'Tab': 'indent', 'Shift-Tab': 'outdent'});\n    };\n\n    AceWrapper.prototype.releaseTab = function () {\n        this.capturingTab = false;\n        this.editor.commands.bindKeys({'Tab': null, 'Shift-Tab': null});\n    };\n\n    // Sometimes Ace editors do not load until the mouse is moved. To fix this,\n    // 'move' the mouse using JQuerry when the editor div enters the viewport.\n    AceWrapper.prototype.fixSlowLoad = function () {\n        const observer = new IntersectionObserver( () => {\n            $(document).trigger('mousemove');\n        });\n        const editNode = this.editNode.get(0); // Non-JQuerry node.\n        observer.observe(editNode);\n    };\n\n    AceWrapper.prototype.setEventHandlers = function () {\n        var TAB = 9,\n            ESC = 27,\n            KEY_M = 77,\n            t = this;\n\n        this.editor.getSession().on('change', function() {\n            t.textarea.val(t.editor.getSession().getValue());\n            t.contents_changed = true;\n        });\n\n        this.editor.on('blur', function() {\n            if (t.contents_changed) {\n                t.textarea.trigger('change');\n            }\n        });\n\n        this.editor.on('mousedown', function() {\n            // Event order seems to be (\\ is where the mouse button is pressed, / released):\n            // Chrome: \\ mousedown, mouseup, focusin / click.\n            // Firefox/IE: \\ mousedown, focusin / mouseup, click.\n            t.clickInProgress = true;\n        });\n\n        this.editor.on('focus', function() {\n            if (t.clickInProgress) {\n                t.captureTab();\n            } else {\n                t.releaseTab();\n            }\n        });\n\n        this.editor.on('click', function() {\n            t.clickInProgress = false;\n        });\n\n        this.editor.container.addEventListener('keydown', function(e) {\n            if (e.which === undefined || e.which !== 0) { // Normal keypress?\n                if (e.keyCode === KEY_M && e.ctrlKey && !e.altKey) {\n                    if (t.capturingTab) {\n                        t.releaseTab();\n                    } else {\n                        t.captureTab();\n                    }\n                    e.preventDefault(); // Firefox uses this for mute audio in current browser tab.\n                }\n                else if (e.keyCode === ESC) {\n                    t.releaseTab();\n                }\n                else if (!(e.shiftKey || e.ctrlKey || e.altKey || e.keyCode == TAB)) {\n                    t.captureTab();\n                }\n            }\n        }, true);\n    };\n\n    AceWrapper.prototype.destroy = function () {\n        var focused;\n        if (!this.fail) {\n            // Proceed only if this wrapper was correctly constructed\n            focused = this.editor.isFocused();\n            this.textarea.val(this.editor.getSession().getValue()); // Copy data back\n            this.editor.destroy();\n            $(this.editNode).remove();\n            if (focused) {\n                this.textarea.focus();\n                this.textarea[0].selectionStart = this.textarea[0].value.length;\n            }\n        }\n    };\n\n    AceWrapper.prototype.hasFocus = function() {\n        return this.editor.isFocused();\n    };\n\n    AceWrapper.prototype.findMode = function (language) {\n        var candidate,\n            filename,\n            result,\n            candidates = [], // List of candidate modes.\n            nameMap = {\n                'octave': 'matlab',\n                'nodejs': 'javascript',\n                'c#': 'cs'\n            };\n\n        if (typeof language !== 'string') {\n            return undefined;\n        }\n        if (language.toLowerCase() in nameMap) {\n            language = nameMap[language.toLowerCase()];\n        }\n\n        candidates = [language, language.replace(/\\d+$/, \"\")];\n        for (var i = 0; i < candidates.length; i++) {\n            candidate = candidates[i];\n            filename = \"input.\" + candidate;\n            result = this.modelist.modesByName[candidate] ||\n                this.modelist.modesByName[candidate.toLowerCase()] ||\n                this.modelist.getModeForPath(filename) ||\n                this.modelist.getModeForPath(filename.toLowerCase());\n\n            if (result && result.name !== 'text') {\n                return result;\n            }\n        }\n        return undefined;\n    };\n\n    AceWrapper.prototype.resize = function(w, h) {\n        this.editNode.outerHeight(h);\n        this.editNode.outerWidth(w);\n        this.editor.resize();\n    };\n\n     return {\n        Constructor: AceWrapper\n    };\n});\n"],"names":["define","$","AceWrapper","textareaId","w","h","params","textarea","document","getElementById","wrapper","focused","activeElement","lang","t","this","window","ace","require","modelist","enabled","contents_changed","capturingTab","clickInProgress","editNode","css","resize","height","width","editor","edit","get","prop","setReadOnly","setOptions","enableBasicAutocompletion","newLineMode","$blockScrolling","Infinity","getSession","setValue","val","fixSlowLoad","theme","setTheme","matchMedia","matches","setLanguage","setEventHandlers","captureTab","renderer","on","gutter","find","hasClass","addClass","focus","navigateFileEnd","aceLabel","attr","aceTextarea","fail","err","prototype","failed","failMessage","sync","syncIntervalSecs","language","session","mode","findMode","setMode","getElement","commands","bindKeys","releaseTab","observer","IntersectionObserver","trigger","observe","getValue","container","addEventListener","e","undefined","which","keyCode","ctrlKey","altKey","preventDefault","shiftKey","destroy","isFocused","remove","selectionStart","value","length","hasFocus","candidate","filename","result","candidates","nameMap","toLowerCase","replace","i","modesByName","getModeForPath","name","outerHeight","outerWidth","Constructor"],"mappings":"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"}