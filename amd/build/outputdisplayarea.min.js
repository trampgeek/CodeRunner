define("qtype_coderunner/outputdisplayarea",["exports","core/ajax","core/str"],(function(_exports,_ajax,_str){var obj;function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||_unsupportedIterableToArray(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupportedIterableToArray(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.OutputDisplayArea=void 0,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};var fn,_ref,JSON_DISPLAY_PROPS=["returncode","stdout","stderr","files"],setLangString=(fn=regeneratorRuntime.mark((function _callee(langStringName,display,additionalText){var message;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,(0,_str.get_string)(langStringName,"qtype_coderunner");case 2:message=_context.sent,display.innerText="*** "+message+" ***\n",additionalText&&(display.innerText+=additionalText);case 5:case"end":return _context.stop()}}),_callee)})),_ref=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(_x,_x2,_x3){return _ref.apply(this,arguments)}),combinedOutput=function(response){return response.cmpinfo+response.output+response.stderr},getImage=function(base64){var type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"png",image=document.createElement("img");return image.src="data:image/".concat(type,";base64,").concat(base64),image},OutputDisplayArea=function(){function OutputDisplayArea(displayAreaId,outputMode,lang,sandboxParams){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,OutputDisplayArea),this.displayAreaId=displayAreaId,this.lang=lang,this.mode=outputMode,this.sandboxParams=sandboxParams,this.textDisplay=document.getElementById(displayAreaId+"-text"),this.imageDisplay=document.getElementById(displayAreaId+"-images"),this.prevRunSettings=null}var Constructor,protoProps,staticProps;return Constructor=OutputDisplayArea,protoProps=[{key:"clearDisplay",value:function(){this.textDisplay.innerHTML="",this.imageDisplay.innerHTML=""}},{key:"displayText",value:function(response){this.textDisplay.innerText=combinedOutput(response)}},{key:"displayHtml",value:function(response){this.textDisplay.innerHTML=combinedOutput(response);var inputEl=this.textDisplay.querySelector(".coderunner-run-input");inputEl&&this.addInputEvents(inputEl)}},{key:"displayJson",value:function(response){var result=this.validateJson(response.output),text=result.stdout;42!==result.returncode&&(text+=result.stderr),13==result.returncode&&(text+="\n*** Timeout error ***\n");var numImages=this.displayImages(result.files);""===text.trim()&&42!==result.returncode?0==numImages&&this.displayNoOutput(null):this.textDisplay.innerText=text,42===result.returncode&&this.addInput()}},{key:"validateJson",value:function(jsonString){var result=null;try{result=JSON.parse(jsonString)}catch(e){window.alert("Error parsing display JSON output: \n                ".concat(jsonString,"\n                JSON Parsing error Msg: \n                ").concat(e.message,"\n                The question author must fix this!"))}var missing=function(obj,props){return props.filter((function(prop){return!obj.hasOwnProperty(prop)}))}(result,JSON_DISPLAY_PROPS);return missing.length>0&&window.alert("Display JSON (in response.result) is missing the following fields:\n                ".concat(missing.join(),"\n                The question author must fix this!")),result}},{key:"displayNoOutput",value:function(response){var isNoOutput=!response||0===combinedOutput(response).length;if(isNoOutput||null===response){var span=document.createElement("span");span.style.color="red",span.innerText="< No output! >",this.clearDisplay(),this.textDisplay.append(span)}return isNoOutput}},{key:"display",value:function(response){var error=function(response){for(var ERROR_RESPONSES=[[1,0,"error_access_denied"],[2,0,"error_unknown_language"],[3,0,"error_access_denied"],[4,0,"error_submission_limit_reached"],[5,0,"error_sandbox_server_overload"],[0,11,""],[0,12,""],[0,13,"error_timeout"],[0,15,""],[0,17,"error_memory_limit"],[0,21,"error_sandbox_server_overload"],[0,30,"error_excessive_output"]],i=0;i<ERROR_RESPONSES.length;i++){var row=ERROR_RESPONSES[i];if(row[0]==response.error&&(0!=response.error||response.result==row[1]))return row[2]}return"error_unknown_runtime"}(response);if(""===error){if(!this.displayNoOutput(response))if("json"===this.mode)this.displayJson(response);else if("html"===this.mode)this.displayHtml(response);else{if("text"!==this.mode)throw Error('Invalid outputMode given: "'.concat(this.mode,'"'));this.displayText(response)}}else setLangString(error,this.textDisplay)}},{key:"runCode",value:function(code,stdin){var _this=this,shouldClearDisplay=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.prevRunSettings=[code,stdin],shouldClearDisplay&&this.clearDisplay(),_ajax.default.call([{methodname:"qtype_coderunner_run_in_sandbox",args:{contextid:M.cfg.contextid,sourcecode:code,language:this.lang,stdin:stdin,params:JSON.stringify(this.sandboxParams)},done:function(responseJson){var response=JSON.parse(responseJson);_this.display(response)},fail:function(error){alert(error.message)}}])}},{key:"addInput",value:function(){var inputId="".concat(this.displayAreaId,"-input-field");this.textDisplay.innerHTML+='<input type="text" id="'.concat(inputId,'" class="').concat("coderunner-run-input",'">');var inputEl=document.getElementById(inputId);this.addInputEvents(inputEl)}},{key:"addInputEvents",value:function(inputEl){var _this2=this;inputEl.focus(),inputEl.addEventListener("keydown",(function(e){13===e.keyCode&&e.preventDefault()})),inputEl.addEventListener("keyup",(function(e){if(13===e.keyCode){var line=inputEl.value;inputEl.remove(),_this2.textDisplay.innterHTML+=line,_this2.prevRunSettings[1]+=line+"\n",_this2.runCode.apply(_this2,_toConsumableArray(_this2.prevRunSettings).concat([!1]))}}))}},{key:"displayImages",value:function(files){for(var numImages=0,_i=0,_Object$entries=Object.entries(files);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),fname=_Object$entries$_i[0],fcontents=_Object$entries$_i[1],fileType=fname.split(".")[1];if(fileType){var image=getImage(fcontents,fileType);this.imageDisplay.append(image),numImages+=1}else window.alert("Could not read filename correctly: ".concat(fname))}return numImages}}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),OutputDisplayArea}();_exports.OutputDisplayArea=OutputDisplayArea}));

//# sourceMappingURL=outputdisplayarea.min.js.map